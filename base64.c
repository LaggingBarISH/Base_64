#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

#include "tools.h"
#include "base64.h"

#define B64_Padding '='

char* B64_Alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

char* Base64Encode(unsigned char* data, size_t size){
	unsigned char* out;
	size_t outSize = (size + 2) / 3 * 4;
	out = malloc(outSize + 1);
	checkPtr(out, _LINE_);
	*(out + outSize) = 0;
	memset(&out[outSize - 2], B64_Padding, 2);

	uint32_t i = 0, j = 0;
	for(i = 0; i + 3 < size; i += 3){
		out[j] = B64_Alphabet[data[i] >> 2];
		out[j + 1] = B64_Alphabet[(data[i] << 4 & 0b00111111) + (data[i + 1] >> 4)];
		out[j + 2] = B64_Alphabet[(data[i + 1] << 2 & 0b00111111) + (data[i + 2] >> 6)];
		out[j + 3] = B64_Alphabet[data[i + 2] & 0b00111111];
		j += 4;
	}

	if(i < size){
		out[j] = B64_Alphabet[data[i] >> 2];
		i++;
		j++;
		if(i < size){
			out[j] = B64_Alphabet[(data[i - 1] << 4 & 0b00111111) + (data[i] >> 4)];
			i++;
			j++;
			if(i < size){
				out[j] = B64_Alphabet[(data[i - 1] << 2 & 0b00111111) + (data[i] >> 6)];
				out[j + 1] = B64_Alphabet[data[i] & 0b00111111];
			} else out[j] = B64_Alphabet[data[i - 1] << 2 & 0b00111111];
		} else out[j] = B64_Alphabet[data[i - 1] << 4 & 0b00111111];
	}

	return (char*)out;
}

char* Base64Decode(unsigned char* data, size_t* size){	
	size_t outSize;
	if (*size) outSize = (*size + 3) / 4 * 3;
	else outSize = (strlen((char*)data) + 3) / 4 * 3;
	
	unsigned char* out;
	out = malloc(outSize);
	checkPtr(out, _LINE_);
	
	int i = 0;
	int val[4];	
	while(1){
		if(*(data + i) > 122)		checkPtr(NULL, "Base64 encoding on the input file is corrupted. " _LINE_);
		else if(*(data + i) > 96)	val[i % 4] = *(data + i) - 71;
		else if(*(data + i) > 90)	checkPtr(NULL, "Base64 encoding on the input file is corrupted. " _LINE_);
		else if(*(data + i) > 64)	val[i % 4] = *(data + i) - 65;
		else if(*(data + i) == 0 || *(data + i) == B64_Padding || i == (int)*size){
			if		(i % 4 == 1)	{ checkPtr(NULL, "Base64 encoding on the input file is corrupted. " _LINE_); }
			else if	(i % 4 == 2)	{ *(out + i / 4 * 3) = (val[0] << 2) + (val[1] >> 4); }
			else if	(i % 4 == 3)	{ *(out + i / 4 * 3) = (val[0] << 2) + (val[1] >> 4); *(out + i / 4 * 3 + 1) = (val[1] << 4) + (val[2] >> 2); }
			break;}
		else if(*(data + i) > 57)	checkPtr(NULL, "Base64 encoding on the input file is corrupted. " _LINE_);
		else if(*(data + i) > 47)	val[i % 4] = *(data + i) + 4;
		else if(*(data + i) == 47)	val[i % 4] = 63;
		else if(*(data + i) == 43)	val[i % 4] = 62;
		else						checkPtr(NULL, "Base64 encoding on the input file is corrupted. " _LINE_);

		if(i % 4 == 3){
			*(out + i / 4 * 3)		= (val[0] << 2) + (val[1] >> 4);
			*(out + i / 4 * 3 + 1)	= (val[1] << 4) + (val[2] >> 2);
			*(out + i / 4 * 3 + 2)	= (val[2] << 6) + (val[3]);
		}
		i++;
	}
	*size = (i / 4 * 3) + (!!(i % 4) * (i - 1) % 4);
	
	return (char*)out;
}


/*	Sample Use

char mydata[1024] = {
					0x06, 0x0a, 0x87, 0xa1, 0x19, 0x77, 0x41, 0xdd, 
					0x2b, 0x49, 0x6b, 0x67, 0x0e, 0x4a, 0x0d, 0xfd, 
					0x3e, 0x2a, 0x26, 0xd9, 0x81, 0xe7, 0xa4, 0x13, 
					0xea, 0x61, 0x99, 0x78, 0xf1, 0xa1, 0x01, 0x11, 
					0x09, 0x3a, 0xd3, 0x64, 0xe1, 0x44, 0x38, 0xf1, 
					0x4d, 0xeb, 0xa3, 0xd4, 0x03, 0xaa, 0x21, 0x63, 
					0x51, 0xcc, 0xd4, 0x6d, 0x31, 0x89, 0x98, 0x4f, 
					0x35, 0xb1, 0x7f, 0xb2, 0xd4, 0x4c, 0xf3, 0x5f, 
					0x15, 0x74, 0x49, 0x1a, 0x59, 0x07, 0x2a, 0xb2, 
					0xb0, 0x15, 0x85, 0xe7, 0x66, 0x57, 0x69, 0x36, 
					0x2d, 0x53, 0x9c, 0x9c, 0x13, 0xab, 0xbf, 0xb0, 
					0x92, 0xe2, 0x67, 0x0a, 0x1d, 0xe5, 0x69, 0x05, 
					0xd2, 0x52, 0x1c, 0x33, 0x52, 0x5e, 0x22, 0x86, 
					0x65, 0x03, 0x1f, 0x4c, 0xb2, 0x84, 0x54, 0x7e, 
					0xaf, 0x0f, 0xd5, 0x98, 0x94, 0xc6, 0xf9, 0x96, 
					0xf9, 0x48, 0xc4, 0x04, 0x99, 0x65, 0x3f, 0x04, 
					0x58, 0xf7, 0x5c, 0xa5, 0x2e, 0x9e, 0xfb, 0xc8, 
					0x53, 0xb6, 0xe7, 0x84, 0xe4, 0x28, 0x28, 0x49, 
					0x9b, 0xfc, 0x54, 0x43, 0x73, 0x19, 0x65, 0x64, 
					0xcd, 0x98, 0x8b, 0x7a, 0x96, 0x7e, 0x8b, 0xa2, 
					0xbd, 0x77, 0xcd, 0xfb, 0xe8, 0xae, 0xca, 0xeb, 
					0xec, 0xc9, 0xdd, 0x32, 0x68, 0xcc, 0x13, 0xf8, 
					0xe0, 0x3b, 0xca, 0xc5, 0x1f, 0xbe, 0x26, 0xf0, 
					0xb8, 0x1f, 0x5f, 0xb5, 0x1b, 0x2b, 0x31, 0x71, 
					0x66, 0x75, 0xd2, 0x8c, 0xd7, 0x68, 0x03, 0x7d, 
					0x71, 0x6b, 0xe9, 0x96, 0xc4, 0x09, 0x2a, 0x83, 
					0xf3, 0xe0, 0xe4, 0xe3, 0x82, 0xe2, 0xc1, 0x0c, 
					0x32, 0xce, 0x1e, 0x5c, 0x64, 0x62, 0x2b, 0xfd, 
					0x23, 0x0d, 0x85, 0x3f, 0xa1, 0xaa, 0x69, 0xae, 
					0x9f, 0x8a, 0xa8, 0x16, 0x81, 0x2e, 0xcf, 0x25, 
					0x87, 0x47, 0xc2, 0x5b, 0x5e, 0x81, 0xef, 0xcb, 
					0xba, 0x61, 0xa3, 0xbc, 0x56, 0x59, 0xd8, 0xd5, 
					0x06, 0x0a, 0x87, 0xa1, 0x19, 0x77, 0x41, 0xdd, 
					0x2b, 0x49, 0x6b, 0x67, 0x0e, 0x4a, 0x0d, 0xfd, 
					0x3e, 0x2a, 0x26, 0xd9, 0x81, 0xe7, 0xa4, 0x13, 
					0xea, 0x61, 0x99, 0x78, 0xf1, 0xa1, 0x01, 0x11, 
					0x09, 0x3a, 0xd3, 0x64, 0xe1, 0x44, 0x38, 0xf1, 
					0x4d, 0xeb, 0xa3, 0xd4, 0x03, 0xaa, 0x21, 0x63, 
					0x51, 0xcc, 0xd4, 0x6d, 0x31, 0x89, 0x98, 0x4f, 
					0x35, 0xb1, 0x7f, 0xb2, 0xd4, 0x4c, 0xf3, 0x5f, 
					0x15, 0x74, 0x49, 0x1a, 0x59, 0x07, 0x2a, 0xb2, 
					0xb0, 0x15, 0x85, 0xe7, 0x66, 0x57, 0x69, 0x36, 
					0x2d, 0x53, 0x9c, 0x9c, 0x13, 0xab, 0xbf, 0xb0, 
					0x92, 0xe2, 0x67, 0x0a, 0x1d, 0xe5, 0x69, 0x05, 
					0xd2, 0x52, 0x1c, 0x33, 0x52, 0x5e, 0x22, 0x86, 
					0x65, 0x03, 0x1f, 0x4c, 0xb2, 0x84, 0x54, 0x7e, 
					0xaf, 0x0f, 0xd5, 0x98, 0x94, 0xc6, 0xf9, 0x96, 
					0xf9, 0x48, 0xc4, 0x04, 0x99, 0x65, 0x3f, 0x04, 
					0x58, 0xf7, 0x5c, 0xa5, 0x2e, 0x9e, 0xfb, 0xc8, 
					0x53, 0xb6, 0xe7, 0x84, 0xe4, 0x28, 0x28, 0x49, 
					0x9b, 0xfc, 0x54, 0x43, 0x73, 0x19, 0x65, 0x64, 
					0xcd, 0x98, 0x8b, 0x7a, 0x96, 0x7e, 0x8b, 0xa2, 
					0xbd, 0x77, 0xcd, 0xfb, 0xe8, 0xae, 0xca, 0xeb, 
					0xec, 0xc9, 0xdd, 0x32, 0x68, 0xcc, 0x13, 0xf8, 
					0xe0, 0x3b, 0xca, 0xc5, 0x1f, 0xbe, 0x26, 0xf0, 
					0xb8, 0x1f, 0x5f, 0xb5, 0x1b, 0x2b, 0x31, 0x71, 
					0x66, 0x75, 0xd2, 0x8c, 0xd7, 0x68, 0x03, 0x7d, 
					0x71, 0x6b, 0xe9, 0x96, 0xc4, 0x09, 0x2a, 0x83, 
					0xf3, 0xe0, 0xe4, 0xe3, 0x82, 0xe2, 0xc1, 0x0c, 
					0x32, 0xce, 0x1e, 0x5c, 0x64, 0x62, 0x2b, 0xfd, 
					0x23, 0x0d, 0x85, 0x3f, 0xa1, 0xaa, 0x69, 0xae, 
					0x9f, 0x8a, 0xa8, 0x16, 0x81, 0x2e, 0xcf, 0x25, 
					0x87, 0x47, 0xc2, 0x5b, 0x5e, 0x81, 0xef, 0xcb, 
					0xba, 0x61, 0xa3, 0xbc, 0x56, 0x59, 0xd8, 0xd5, 
					0x06, 0x0a, 0x87, 0xa1, 0x19, 0x77, 0x41, 0xdd, 
					0x2b, 0x49, 0x6b, 0x67, 0x0e, 0x4a, 0x0d, 0xfd, 
					0x3e, 0x2a, 0x26, 0xd9, 0x81, 0xe7, 0xa4, 0x13, 
					0xea, 0x61, 0x99, 0x78, 0xf1, 0xa1, 0x01, 0x11, 
					0x09, 0x3a, 0xd3, 0x64, 0xe1, 0x44, 0x38, 0xf1, 
					0x4d, 0xeb, 0xa3, 0xd4, 0x03, 0xaa, 0x21, 0x63, 
					0x51, 0xcc, 0xd4, 0x6d, 0x31, 0x89, 0x98, 0x4f, 
					0x35, 0xb1, 0x7f, 0xb2, 0xd4, 0x4c, 0xf3, 0x5f, 
					0x15, 0x74, 0x49, 0x1a, 0x59, 0x07, 0x2a, 0xb2, 
					0xb0, 0x15, 0x85, 0xe7, 0x66, 0x57, 0x69, 0x36, 
					0x2d, 0x53, 0x9c, 0x9c, 0x13, 0xab, 0xbf, 0xb0, 
					0x92, 0xe2, 0x67, 0x0a, 0x1d, 0xe5, 0x69, 0x05, 
					0xd2, 0x52, 0x1c, 0x33, 0x52, 0x5e, 0x22, 0x86, 
					0x65, 0x03, 0x1f, 0x4c, 0xb2, 0x84, 0x54, 0x7e, 
					0xaf, 0x0f, 0xd5, 0x98, 0x94, 0xc6, 0xf9, 0x96, 
					0xf9, 0x48, 0xc4, 0x04, 0x99, 0x65, 0x3f, 0x04, 
					0x58, 0xf7, 0x5c, 0xa5, 0x2e, 0x9e, 0xfb, 0xc8, 
					0x53, 0xb6, 0xe7, 0x84, 0xe4, 0x28, 0x28, 0x49, 
					0x9b, 0xfc, 0x54, 0x43, 0x73, 0x19, 0x65, 0x64, 
					0xcd, 0x98, 0x8b, 0x7a, 0x96, 0x7e, 0x8b, 0xa2, 
					0xbd, 0x77, 0xcd, 0xfb, 0xe8, 0xae, 0xca, 0xeb, 
					0xec, 0xc9, 0xdd, 0x32, 0x68, 0xcc, 0x13, 0xf8, 
					0xe0, 0x3b, 0xca, 0xc5, 0x1f, 0xbe, 0x26, 0xf0, 
					0xb8, 0x1f, 0x5f, 0xb5, 0x1b, 0x2b, 0x31, 0x71, 
					0x66, 0x75, 0xd2, 0x8c, 0xd7, 0x68, 0x03, 0x7d, 
					0x71, 0x6b, 0xe9, 0x96, 0xc4, 0x09, 0x2a, 0x83, 
					0xf3, 0xe0, 0xe4, 0xe3, 0x82, 0xe2, 0xc1, 0x0c, 
					0x32, 0xce, 0x1e, 0x5c, 0x64, 0x62, 0x2b, 0xfd, 
					0x23, 0x0d, 0x85, 0x3f, 0xa1, 0xaa, 0x69, 0xae, 
					0x9f, 0x8a, 0xa8, 0x16, 0x81, 0x2e, 0xcf, 0x25, 
					0x87, 0x47, 0xc2, 0x5b, 0x5e, 0x81, 0xef, 0xcb, 
					0xba, 0x61, 0xa3, 0xbc, 0x56, 0x59, 0xd8, 0xd5, 
					0x06, 0x0a, 0x87, 0xa1, 0x19, 0x77, 0x41, 0xdd, 
					0x2b, 0x49, 0x6b, 0x67, 0x0e, 0x4a, 0x0d, 0xfd, 
					0x3e, 0x2a, 0x26, 0xd9, 0x81, 0xe7, 0xa4, 0x13, 
					0xea, 0x61, 0x99, 0x78, 0xf1, 0xa1, 0x01, 0x11, 
					0x09, 0x3a, 0xd3, 0x64, 0xe1, 0x44, 0x38, 0xf1, 
					0x4d, 0xeb, 0xa3, 0xd4, 0x03, 0xaa, 0x21, 0x63, 
					0x51, 0xcc, 0xd4, 0x6d, 0x31, 0x89, 0x98, 0x4f, 
					0x35, 0xb1, 0x7f, 0xb2, 0xd4, 0x4c, 0xf3, 0x5f, 
					0x15, 0x74, 0x49, 0x1a, 0x59, 0x07, 0x2a, 0xb2, 
					0xb0, 0x15, 0x85, 0xe7, 0x66, 0x57, 0x69, 0x36, 
					0x2d, 0x53, 0x9c, 0x9c, 0x13, 0xab, 0xbf, 0xb0, 
					0x92, 0xe2, 0x67, 0x0a, 0x1d, 0xe5, 0x69, 0x05, 
					0xd2, 0x52, 0x1c, 0x33, 0x52, 0x5e, 0x22, 0x86, 
					0x65, 0x03, 0x1f, 0x4c, 0xb2, 0x84, 0x54, 0x7e, 
					0xaf, 0x0f, 0xd5, 0x98, 0x94, 0xc6, 0xf9, 0x96, 
					0xf9, 0x48, 0xc4, 0x04, 0x99, 0x65, 0x3f, 0x04, 
					0x58, 0xf7, 0x5c, 0xa5, 0x2e, 0x9e, 0xfb, 0xc8, 
					0x53, 0xb6, 0xe7, 0x84, 0xe4, 0x28, 0x28, 0x49, 
					0x9b, 0xfc, 0x54, 0x43, 0x73, 0x19, 0x65, 0x64, 
					0xcd, 0x98, 0x8b, 0x7a, 0x96, 0x7e, 0x8b, 0xa2, 
					0xbd, 0x77, 0xcd, 0xfb, 0xe8, 0xae, 0xca, 0xeb, 
					0xec, 0xc9, 0xdd, 0x32, 0x68, 0xcc, 0x13, 0xf8, 
					0xe0, 0x3b, 0xca, 0xc5, 0x1f, 0xbe, 0x26, 0xf0, 
					0xb8, 0x1f, 0x5f, 0xb5, 0x1b, 0x2b, 0x31, 0x71, 
					0x66, 0x75, 0xd2, 0x8c, 0xd7, 0x68, 0x03, 0x7d, 
					0x71, 0x6b, 0xe9, 0x96, 0xc4, 0x09, 0x2a, 0x83, 
					0xf3, 0xe0, 0xe4, 0xe3, 0x82, 0xe2, 0xc1, 0x0c, 
					0x32, 0xce, 0x1e, 0x5c, 0x64, 0x62, 0x2b, 0xfd, 
					0x23, 0x0d, 0x85, 0x3f, 0xa1, 0xaa, 0x69, 0xae, 
					0x9f, 0x8a, 0xa8, 0x16, 0x81, 0x2e, 0xcf, 0x25, 
					0x87, 0x47, 0xc2, 0x5b, 0x5e, 0x81, 0xef, 0xcb, 
					0xba, 0x61, 0xa3, 0xbc, 0x56, 0x59, 0xd8, 0xd5};


char* out = Base64Encode((char*)&mydata, 1024);
printf("%s\n", *out);

size_t k = 0;
out = Base64Decode(out, &k);
printf("%i\n", k);
int j;
for(j = 0; j < k; j++){
	printf("0x%02hhx, ", (unsigned char)*(out + j));
}
printf("\n");
free(out);
*/
